---
# =============================================================================
# Splunk Universal Forwarder Windows Integration Tests
# =============================================================================

# Pre-Test Cleanup and Baseline Verification
- name: "SETUP | Ensure Splunk is not installed before tests"
  splunk.enterprise.win_splunk_universal_forwarder:
    state: absent
    purge: true
    install_dir: "{{ splunk_install_dir }}"
    temp_dir: "{{ splunk_temp_dir }}"
  register: pretest_cleanup

- name: "SETUP | Gather info when Splunk is not installed"
  splunk.enterprise.win_splunk_universal_forwarder_info:
    username: "{{ splunk_username }}"
    password: "{{ splunk_password }}"
    install_dir: "{{ splunk_install_dir }}"
  register: info_absent

- name: "SETUP | Verify info when Splunk is absent"
  ansible.builtin.assert:
    that:
      - info_absent is not changed
      - info_absent.state == 'absent'
      - info_absent.splunk_home == splunk_install_dir
    fail_msg: "Info module should report state=absent when Splunk is not installed"

# Main Test Block - ensures cleanup runs even on failure
- name: "Run all integration tests"
  block:
    # Install Tests
    - name: "INSTALL | Check mode - Install Splunk Universal Forwarder"
      splunk.enterprise.win_splunk_universal_forwarder:
        state: present
        version: "{{ splunk_version_base }}"
        release_id: "{{ splunk_release_id_base }}"
        splunk_username: "{{ splunk_username }}"
        splunk_password: "{{ splunk_password }}"
        install_dir: "{{ splunk_install_dir }}"
        temp_dir: "{{ splunk_temp_dir }}"
        service_account_type: local_system
      check_mode: true
      register: install_check_mode

    - name: "INSTALL | Verify check mode reports changed"
      ansible.builtin.assert:
        that:
          - install_check_mode is changed
        fail_msg: "Check mode should report changed for new installation"

    - name: "INSTALL | Actually install Splunk Universal Forwarder"
      splunk.enterprise.win_splunk_universal_forwarder:
        state: present
        version: "{{ splunk_version_base }}"
        release_id: "{{ splunk_release_id_base }}"
        splunk_username: "{{ splunk_username }}"
        splunk_password: "{{ splunk_password }}"
        install_dir: "{{ splunk_install_dir }}"
        temp_dir: "{{ splunk_temp_dir }}"
        service_account_type: local_system
      register: install_result

    - name: "INSTALL | Verify installation succeeded"
      ansible.builtin.assert:
        that:
          - install_result is changed
          - install_result.installed == true
          - install_result.installed_version is defined
        fail_msg: "Installation should succeed and report changed"

    - name: "INSTALL | Gather info after installation"
      splunk.enterprise.win_splunk_universal_forwarder_info:
        username: "{{ splunk_username }}"
        password: "{{ splunk_password }}"
        install_dir: "{{ splunk_install_dir }}"
      register: info_after_install

    - name: "INSTALL | Verify info after installation"
      ansible.builtin.assert:
        that:
          - info_after_install.state == 'present'
          - info_after_install.version == splunk_version_base
          - info_after_install.splunk_home == splunk_install_dir
        fail_msg: "Info module should report correct state and version after install"

    - name: "INSTALL | Idempotency - Run install again with same version"
      splunk.enterprise.win_splunk_universal_forwarder:
        state: present
        version: "{{ splunk_version_base }}"
        release_id: "{{ splunk_release_id_base }}"
        splunk_username: "{{ splunk_username }}"
        splunk_password: "{{ splunk_password }}"
        install_dir: "{{ splunk_install_dir }}"
        temp_dir: "{{ splunk_temp_dir }}"
        service_account_type: local_system
      register: install_idempotent

    - name: "INSTALL | Verify idempotency - no changes"
      ansible.builtin.assert:
        that:
          - install_idempotent is not changed
        fail_msg: "Running install with same version should be idempotent (no changes)"

    - name: "FORWARD_SERVERS | Set initial forward servers"
      splunk.enterprise.win_splunk_universal_forwarder:
        state: present
        version: "{{ splunk_version_base }}"
        release_id: "{{ splunk_release_id_base }}"
        splunk_username: "{{ splunk_username }}"
        splunk_password: "{{ splunk_password }}"
        install_dir: "{{ splunk_install_dir }}"
        forward_servers:
          - "10.46.29.168:9997"
          - "10.46.29.214:9997"
      register: fwd_set_result

    - name: "FORWARD_SERVERS | Verify forward servers were set"
      ansible.builtin.assert:
        that:
          - fwd_set_result is changed
        fail_msg: "Setting forward servers should report changed"

    - name: "FORWARD_SERVERS | Gather info to verify forward servers"
      splunk.enterprise.win_splunk_universal_forwarder_info:
        username: "{{ splunk_username }}"
        password: "{{ splunk_password }}"
        install_dir: "{{ splunk_install_dir }}"
      register: info_with_fwd_servers

    - name: "FORWARD_SERVERS | Verify forward servers in info output"
      ansible.builtin.assert:
        that:
          - info_with_fwd_servers.forward_servers | length == 2
        fail_msg: "Info should show configured forward servers"

    - name: "FORWARD_SERVERS | Idempotency - Set same forward servers again"
      splunk.enterprise.win_splunk_universal_forwarder:
        state: present
        version: "{{ splunk_version_base }}"
        release_id: "{{ splunk_release_id_base }}"
        splunk_username: "{{ splunk_username }}"
        splunk_password: "{{ splunk_password }}"
        install_dir: "{{ splunk_install_dir }}"
        forward_servers:
          - "10.46.29.168:9997"
          - "10.46.29.214:9997"
      register: fwd_set_idempotent

    - name: "FORWARD_SERVERS | Verify idempotency"
      ansible.builtin.assert:
        that:
          - fwd_set_idempotent is not changed
        fail_msg: "Setting same forward servers should be idempotent"

    - name: "FORWARD_SERVERS | Remove all forward servers"
      splunk.enterprise.win_splunk_universal_forwarder:
        state: present
        version: "{{ splunk_version_base }}"
        release_id: "{{ splunk_release_id_base }}"
        splunk_username: "{{ splunk_username }}"
        splunk_password: "{{ splunk_password }}"
        install_dir: "{{ splunk_install_dir }}"
        forward_servers: []
      register: fwd_remove_result

    - name: "FORWARD_SERVERS | Verify forward servers were removed"
      ansible.builtin.assert:
        that:
          - fwd_remove_result is changed
        fail_msg: "Removing forward servers should report changed"

    - name: "FORWARD_SERVERS | Gather info to verify no forward servers"
      splunk.enterprise.win_splunk_universal_forwarder_info:
        username: "{{ splunk_username }}"
        password: "{{ splunk_password }}"
        install_dir: "{{ splunk_install_dir }}"
      register: info_no_fwd_servers

    - name: "FORWARD_SERVERS | Verify no forward servers in info"
      ansible.builtin.assert:
        that:
          - info_no_fwd_servers.forward_servers | length == 0
        fail_msg: "Info should show no forward servers after removal"

    - name: "DEPLOYMENT_SERVER | Set initial deployment server"
      splunk.enterprise.win_splunk_universal_forwarder:
        state: present
        version: "{{ splunk_version_base }}"
        release_id: "{{ splunk_release_id_base }}"
        splunk_username: "{{ splunk_username }}"
        splunk_password: "{{ splunk_password }}"
        install_dir: "{{ splunk_install_dir }}"
        deployment_server: "10.46.29.168:8089"
      register: ds_set_result

    - name: "DEPLOYMENT_SERVER | Verify deployment server was set"
      ansible.builtin.assert:
        that:
          - ds_set_result is changed
        fail_msg: "Setting deployment server should report changed"

    - name: "DEPLOYMENT_SERVER | Gather info to verify deployment server"
      splunk.enterprise.win_splunk_universal_forwarder_info:
        username: "{{ splunk_username }}"
        password: "{{ splunk_password }}"
        install_dir: "{{ splunk_install_dir }}"
      register: info_with_ds

    - name: "DEPLOYMENT_SERVER | Verify deployment server in info"
      ansible.builtin.assert:
        that:
          - info_with_ds.deployment_server is defined
          - "'10.46.29.168:8089' in info_with_ds.deployment_server"
        fail_msg: "Info should show configured deployment server"

    - name: "DEPLOYMENT_SERVER | Idempotency - Set same deployment server"
      splunk.enterprise.win_splunk_universal_forwarder:
        state: present
        version: "{{ splunk_version_base }}"
        release_id: "{{ splunk_release_id_base }}"
        splunk_username: "{{ splunk_username }}"
        splunk_password: "{{ splunk_password }}"
        install_dir: "{{ splunk_install_dir }}"
        deployment_server: "10.46.29.168:8089"
      register: ds_set_idempotent

    - name: "DEPLOYMENT_SERVER | Verify idempotency"
      ansible.builtin.assert:
        that:
          - ds_set_idempotent is not changed
        fail_msg: "Setting same deployment server should be idempotent"

    - name: "DEPLOYMENT_SERVER | Remove deployment server"
      splunk.enterprise.win_splunk_universal_forwarder:
        state: present
        version: "{{ splunk_version_base }}"
        release_id: "{{ splunk_release_id_base }}"
        splunk_username: "{{ splunk_username }}"
        splunk_password: "{{ splunk_password }}"
        install_dir: "{{ splunk_install_dir }}"
        deployment_server: "NONE"
      register: ds_remove_result

    - name: "DEPLOYMENT_SERVER | Verify deployment server was removed"
      ansible.builtin.assert:
        that:
          - ds_remove_result is changed
          - ds_remove_result.deploymentclient_conf_removed | default(false) == true
        fail_msg: "Removing deployment server should report changed"

    - name: "DEPLOYMENT_SERVER | Gather info to verify no deployment server"
      splunk.enterprise.win_splunk_universal_forwarder_info:
        username: "{{ splunk_username }}"
        password: "{{ splunk_password }}"
        install_dir: "{{ splunk_install_dir }}"
      register: info_no_ds

    - name: "DEPLOYMENT_SERVER | Verify no deployment server in info"
      ansible.builtin.assert:
        that:
          - info_no_ds.deployment_server is not defined or info_no_ds.deployment_server == ''
        fail_msg: "Info should show no deployment server after removal"

    - name: "UPGRADE | Actually upgrade to newer version"
      splunk.enterprise.win_splunk_universal_forwarder:
        state: present
        version: "{{ splunk_version_upgrade }}"
        release_id: "{{ splunk_release_id_upgrade }}"
        splunk_username: "{{ splunk_username }}"
        splunk_password: "{{ splunk_password }}"
        install_dir: "{{ splunk_install_dir }}"
        temp_dir: "{{ splunk_temp_dir }}"
        service_account_type: local_system
      register: upgrade_result

    - name: "UPGRADE | Verify upgrade succeeded"
      ansible.builtin.assert:
        that:
          - upgrade_result is changed
          - upgrade_result.installed == true
        fail_msg: "Upgrade should succeed and report changed"

    - name: "UPGRADE | Gather info after upgrade"
      splunk.enterprise.win_splunk_universal_forwarder_info:
        username: "{{ splunk_username }}"
        password: "{{ splunk_password }}"
        install_dir: "{{ splunk_install_dir }}"
      register: info_after_upgrade

    - name: "UPGRADE | Verify upgraded version"
      ansible.builtin.assert:
        that:
          - info_after_upgrade.state == 'present'
          - info_after_upgrade.version == splunk_version_upgrade
        fail_msg: "Version should be upgraded to {{ splunk_version_upgrade }}"

    - name: "DOWNGRADE | Attempt to downgrade (should fail)"
      splunk.enterprise.win_splunk_universal_forwarder:
        state: present
        version: "{{ splunk_version_downgrade }}"
        release_id: "{{ splunk_release_id_downgrade }}"
        splunk_username: "{{ splunk_username }}"
        splunk_password: "{{ splunk_password }}"
        install_dir: "{{ splunk_install_dir }}"
        temp_dir: "{{ splunk_temp_dir }}"
        service_account_type: local_system
      register: downgrade_result
      failed_when:
        - downgrade_result.failed == false
        - "'Downgrade is not supported' not in downgrade_result.msg"

    - name: "DOWNGRADE | Verify version unchanged after failed downgrade"
      splunk.enterprise.win_splunk_universal_forwarder_info:
        username: "{{ splunk_username }}"
        password: "{{ splunk_password }}"
        install_dir: "{{ splunk_install_dir }}"
      register: info_after_downgrade_attempt

    - name: "DOWNGRADE | Assert version still upgraded version"
      ansible.builtin.assert:
        that:
          - info_after_downgrade_attempt.version == splunk_version_upgrade
        fail_msg: "Version should remain {{ splunk_version_upgrade }} after failed downgrade"

    - name: "UNINSTALL | Check mode - Uninstall Splunk"
      splunk.enterprise.win_splunk_universal_forwarder:
        state: absent
        install_dir: "{{ splunk_install_dir }}"
        temp_dir: "{{ splunk_temp_dir }}"
      check_mode: true
      register: uninstall_check_mode

    - name: "UNINSTALL | Verify check mode reports changed"
      ansible.builtin.assert:
        that:
          - uninstall_check_mode is changed
        fail_msg: "Check mode should report changed for uninstall"

    - name: "UNINSTALL | Actually uninstall Splunk (no purge)"
      splunk.enterprise.win_splunk_universal_forwarder:
        state: absent
        install_dir: "{{ splunk_install_dir }}"
        temp_dir: "{{ splunk_temp_dir }}"
        purge: false
      register: uninstall_result

    - name: "UNINSTALL | Verify uninstall succeeded"
      ansible.builtin.assert:
        that:
          - uninstall_result is changed
          - uninstall_result.installed == false
        fail_msg: "Uninstall should succeed and report changed"

    - name: "UNINSTALL | Gather info after uninstall"
      splunk.enterprise.win_splunk_universal_forwarder_info:
        username: "{{ splunk_username }}"
        password: "{{ splunk_password }}"
        install_dir: "{{ splunk_install_dir }}"
      register: info_after_uninstall

    - name: "UNINSTALL | Verify Splunk is absent"
      ansible.builtin.assert:
        that:
          - info_after_uninstall.state == 'absent'
        fail_msg: "Info should report state=absent after uninstall"

    - name: "UNINSTALL | Idempotency - Uninstall again"
      splunk.enterprise.win_splunk_universal_forwarder:
        state: absent
        install_dir: "{{ splunk_install_dir }}"
        temp_dir: "{{ splunk_temp_dir }}"
      register: uninstall_idempotent

    - name: "UNINSTALL | Verify idempotency"
      ansible.builtin.assert:
        that:
          - uninstall_idempotent is not changed
        fail_msg: "Uninstalling already-uninstalled Splunk should be idempotent"

  # Always cleanup - runs even if tests fail
  always:
    - name: "CLEANUP | Final uninstall with purge (always runs)"
      splunk.enterprise.win_splunk_universal_forwarder:
        state: absent
        install_dir: "{{ splunk_install_dir }}"
        temp_dir: "{{ splunk_temp_dir }}"
        purge: true
      register: final_cleanup

    - name: "CLEANUP | Verify Splunk is completely removed"
      splunk.enterprise.win_splunk_universal_forwarder_info:
        username: "{{ splunk_username }}"
        password: "{{ splunk_password }}"
        install_dir: "{{ splunk_install_dir }}"
      register: final_info

    - name: "CLEANUP | Assert final state is absent"
      ansible.builtin.assert:
        that:
          - final_info.state == 'absent'
        fail_msg: "Splunk should be completely removed after cleanup"
